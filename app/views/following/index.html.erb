<div class="container">
<h1><img id="avatar" src="<%= @avatar %>" alt="avatar"><%= @user.username %>'s Portfolio</h1>

<%= link_to "Back to Coins", root_url %>

  <div class="row">
    <% count = 0 %>
    <ul class="collapsible" data-collapsible="accordion">
      <% @following.each do |follow| %>
      <% @response_only_btc.each do |coin| %>
      <% if coin["MarketName"] == "BTC-#{follow.coin_name}" %>
      <% @coin_last = coin["Last"] %>
      <% end %>
      <% end %>
    <li>
      <div class="collapsible-header">
        <div class="col s8">
          <h2><%= follow.coin_name %></h2>
        </div>
            <div class="right col s3">
              Current Price: Éƒ <%= number_with_precision(@coin_last, precision: 8) %>
            </div>
            <% if follow.alerts.length > 0 %>
            <div class="right col s1">
              <h4><%= image_tag("alerts", size: "30x30") %>&nbsp;<%= follow.alerts.count %></h4>
            </div>
            <% else %>
            <div class="right col s1">
            </div>
            <% end %>
            <div class="row">
              <div class="col s12">
                <i class="material-icons">arrow_drop_down</i>
              </div>
          </div>
      </div>
      <div class="collapsible-body">
        <table class="bordered">
          <thead>
            <tr>
                <th data-sortable="false">Price above</th>
                <th data-sortable="false">Price below</th>
                <th data-sortable="false">24h change</th>
                <th data-sortable="false">Status</th>
                <th></th>
            </tr>
          </thead>
          <tbody>
            <% follow.alerts.each do |alert| %>
              <tr>
                <td><%= alert.price_above %></td>
                <td><%= alert.price_below %></td>
                <td><%= alert.percent %>%</td>
                <% if alert.state == "Active" %>
                <td><p><%= alert.state %>&nbsp;<%= image_tag("active-alert", size: "20x20") %></p></td>
                <% elsif alert.state == "Inactive" %>
                <td><p><%= alert.state %>&nbsp;<%= image_tag("inactive-alert", size: "20x20") %></p></td>
                <% end %>
                <td><%= link_to "Edit", edit_following_alert_path(follow, alert) %> | <%= link_to "Delete", following_alert_path(follow, alert), method: :delete, data: {confirm: "Are you sure you want to delete this alert?" } %></td>
              </tr>
            <% end %>
            <tr>
              <td colspan="5">
                <button data-target="modal<%= count +=1%>" class="btn modal-trigger cyan accent-4" action="#modal<%= count %>"><i class="material-icons left  modal-trigger">add</i>Add Alert</button>
              </td>
            </tr>
               <div id="modal<%= count %>" class="modal">
                 <div class="modal-content">
                 <!-- cannot render the partial for the alert. for NEW method, it can't be @following, must be >>follow<< like in the iteration -->
                 <%= form_for([follow, @alert]) do |f| %>
                   <% if @alert.errors.any? %>
                     <div id="error_explanation">
                       <h2><%= pluralize(@alert.errors.count, "error") %> prohibited this alert from being saved:</h2>
                       <ul>
                         <% @alert.errors.full_messages.each do |msg| %>
                           <li><%= msg %></li>
                         <% end %>
                       </ul>
                     </div>
                   <% end %>
                   <h5><%= follow.coin_name %></h5>
                   <div class="field">
                     <%= f.label :price_above %><br />
                     <%= f.number_field :price_above, :value => number_with_precision(@coin_last, precision: 8), step: 0.0000001 %>
                   </div>
                   <div class="field">
                     <%= f.label :price_below %><br />
                     <%= f.number_field :price_below, :value => number_with_precision(@coin_last, precision: 8), step: 0.0000001%>
                   </div>
                   <div class="field">
                     <%= f.label '24h percent change' %><br />
                     <%= f.number_field :percent %>
                   </div>
                   <div class="actions">
                     <%= f.submit :class => 'btn modal-trigger cyan accent-4' %>
                   </div>
                 <% end %>
               </div>
               </div>
          </tbody>
        </table>
      </div>
    </li>
    <li>
      <% end %>
  </ul>
  </div>
